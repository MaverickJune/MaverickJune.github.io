<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> SBVR Kernels | Wonjun Bang </title> <meta name="author" content="Wonjun Bang"> <meta name="description" content="Hardware-Friendly Kernel Design of SBVR"> <meta name="keywords" content="mlsys, llm serving, quantization, edge-cloud"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://www.wjbang.site/projects/3_project/"> <link rel="stylesheet" href="/assets/css/custom_project.css"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Wonjun Bang </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">SBVR Kernels</h1> <p class="post-description">Hardware-Friendly Kernel Design of SBVR</p> </header> <article> <p>First, I recommend reading the full paper on SBVR available at <a href="https://arxiv.org/abs/2509.18172" rel="external nofollow noopener" target="_blank">arXiv</a>. Here, I will discuss how we designed a GPU-friendly kernel for SBVR-formatted weights, focusing on the code-level details.</p> <p>We defined a struct template to store the bitvectors in the SBVR format. Each bitvector is divided into 32-bit integers, and one bitvector is stored in a struct instance named <code class="language-plaintext highlighter-rouge">bvrs</code>.</p> <div class="row justify-content-center"> <div class="col-sm-auto mt-3 mt-md-0 text-center"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/bvr_format-480.webp 480w,/assets/img/bvr_format-800.webp 800w,/assets/img/bvr_format-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/bvr_format.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Struct template bvrs (truncated at target-bit 6)" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Struct template bvrs (truncated at target-bit 6) </div> <p>The interface of the kernel that actually computes the GEMV for the <strong>SBVR format</strong> is as follows.<br> It takes the following inputs:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">l/r_bvr</code>: the set of bitvectors representing the LLM weights,</li> <li> <code class="language-plaintext highlighter-rouge">l/r_coeff_cache</code>: the corresponding coefficients for the bitvectors in the SBVR representation,</li> <li> <code class="language-plaintext highlighter-rouge">l/r_coeff_idx</code>: the indices indicating the coefficient positions for each bitvector in <code class="language-plaintext highlighter-rouge">coeff_cache</code>.</li> </ul> <div class="row justify-content-center"> <div class="col-sm-auto mt-3 mt-md-0 text-center"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sbvr_gemv_interface-480.webp 480w,/assets/img/sbvr_gemv_interface-800.webp 800w,/assets/img/sbvr_gemv_interface-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sbvr_gemv_interface.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="SBVR GEMV interface" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> SBVR GEMV interface </div> <p>The actual computation starts from the inner dimension, K (1×K, K×N, GEMV). Here, we divide the K dimension according to the size of the bitvector used for quantization (typically 128).<br> The inner product is computed between two <code class="language-plaintext highlighter-rouge">K_PER_BVR*32</code>-sized vectors and accumulated to produce one final element of the GEMV. This process is executed in parallel across multiple thread blocks, each handling different parts of the outer dimension, N.</p> <div class="row justify-content-center"> <div class="col-sm-auto mt-3 mt-md-0 text-center"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/kernel_for_loop-480.webp 480w,/assets/img/kernel_for_loop-800.webp 800w,/assets/img/kernel_for_loop-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/kernel_for_loop.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Computation order of the kernel" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Computation order of the kernel </div> <p>Now, here comes the interesting part. As mentioned in the paper, we replace the fused multiply-add operation in GEMV with a series of logical bitwise operations (<code class="language-plaintext highlighter-rouge">&amp;</code> and <code class="language-plaintext highlighter-rouge">popcount</code>), followed by a reduction along the K dimension.</p> <div class="row justify-content-center"> <div class="col-sm-auto mt-3 mt-md-0 text-center"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sbvr_inner_product_schematic-480.webp 480w,/assets/img/sbvr_inner_product_schematic-800.webp 800w,/assets/img/sbvr_inner_product_schematic-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sbvr_inner_product_schematic.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="SBVR Inner Product Computation" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> SBVR Inner Product Computation </div> <p>This part can be implemented as follows. First, fetch the target bitvectors from the parameters <code class="language-plaintext highlighter-rouge">l_bvr</code> and <code class="language-plaintext highlighter-rouge">r_bvr</code>. Then compute the <strong>popcount</strong> of the bitwise <strong>AND</strong>. As noted above, each bitvector is stored in the <code class="language-plaintext highlighter-rouge">bvrs</code> struct. In the innermost loop, take one <code class="language-plaintext highlighter-rouge">uint32_t</code> segment from each bitvector and accumulate the partial result <code class="language-plaintext highlighter-rouge">__popc(l_i &amp; r_i)</code> into the <code class="language-plaintext highlighter-rouge">uchar4</code> array <code class="language-plaintext highlighter-rouge">pop_cache</code>. After the outer loop sweeps the K dimension—covering all <code class="language-plaintext highlighter-rouge">K_PER_BVR</code> segments—the <code class="language-plaintext highlighter-rouge">pop_cache</code> contains all combinations of the logical-operation results for the participating bitvectors.</p> <div class="row justify-content-center"> <div class="col-sm-auto mt-3 mt-md-0 text-center"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sbvr_inner_logic_bitwiseops-480.webp 480w,/assets/img/sbvr_inner_logic_bitwiseops-800.webp 800w,/assets/img/sbvr_inner_logic_bitwiseops-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sbvr_inner_logic_bitwiseops.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Handling Bitwise-Operations" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Handling Bitwise-Operations </div> <p>Finally, we multiply the corresponding coefficients of the bitvectors with the logical-operation results stored in <code class="language-plaintext highlighter-rouge">pop_cache</code>.<br> The final reduction result is accumulated in a variable named <code class="language-plaintext highlighter-rouge">sum</code>, and the threads within a warp—each computing different parts of the K dimension—are reduced using <code class="language-plaintext highlighter-rouge">__shfl_down_sync()</code>.<br> The outcome of these computations is then written to the output vector <code class="language-plaintext highlighter-rouge">out</code>. <br><br> This concludes the computation of the SBVR GEMV kernel.</p> <div class="row justify-content-center"> <div class="col-sm-auto mt-3 mt-md-0 text-center"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sbvr_final_reduction-480.webp 480w,/assets/img/sbvr_final_reduction-800.webp 800w,/assets/img/sbvr_final_reduction-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sbvr_final_reduction.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Final Reduction" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Final Reduction </div> <p>You can find more details about the SBVR implementation—such as the parameters used to launch the kernel (grid and block sizes) and how this kernel is integrated into the SBVR forward pass—on <a href="https://github.com/MaverickJune/sbvr" rel="external nofollow noopener" target="_blank">GitHub</a>.</p> </article> </div> </div> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> </body> </html>